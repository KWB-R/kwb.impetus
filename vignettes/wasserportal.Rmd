---
title: "Wasserportal"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Wasserportal}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Install R Package

```{r install_r_package}
# Enable repository from kwb-r
options(repos = c(
  kwbr = 'https://kwb-r.r-universe.dev',
  CRAN = 'https://cloud.r-project.org'))
# Download and install kwb.impetus in R
install.packages('kwb.impetus')
```


## Define Helper Functions 

```{r helper_functions}
library(kwb.impetus)
csv_to_list <- function(variables) {
stats::setNames(lapply(seq_len(length(variables)), function(i) {
 var <- names(variables[i])
url <- sprintf("https://kwb-r.github.io/wasserportal/daily_%s.csv", var)

readr::read_csv(url)

}), nm = names(variables)
)
}

get_master <- function(stations) {
ids <- stations$overview_df %>% 
  dplyr::filter(.data$Betreiber == "Land Berlin") %>% 
  dplyr::count(.data$Messstellennummer, .data$Betreiber) %>% 
  dplyr::pull(.data$Messstellennummer)

wasserportal::get_wasserportal_masters_data(station_ids = ids) %>% 
  dplyr::rename(Messstellennummer = .data$Nummer)

}

round_to_decade <- function(values) {
  unlist(lapply(values, function(value) {
   decade <- value - value %% 10 
     if (value %% 10 >= 5) {
       decade <- decade + 10
     }
   decade
  }))
}

scale_fill_decades <- function(decades, ...){
    ggplot2:::manual_scale(
        'fill', 
        values = setNames(decades$values, 
                          decades$names), 
        ...
    )
}

scale_color_decades <- function(decades, ...){
    ggplot2:::manual_scale(
        'color', 
        values = setNames(decades$values, 
                          decades$names), 
        ...
    )
}

```



## Surface Water 

```{r surface_water}
stations <- wasserportal::get_stations()
variables <- wasserportal::get_surfacewater_variables()
variables <- variables[1:2]
variables

# sw_data_daily_list <- wasserportal::get_daily_surfacewater_data(stations,
#                                                           variables)

wp_master <- get_master(stations) %>% 
  dplyr::mutate(Messstellennummer = as.double(.data$Messstellennummer)) 

wp_data <- csv_to_list(variables) 

```

### Surface Water Level 

```{r surface_water_level}
surfacewater_level_master <- wp_data$surface_water.water_level %>% 
  dplyr::filter(.data$Parameter == "Wasserstand") %>%  
  dplyr::mutate(Datum = as.Date(.data$Datum),
                Jahr = as.integer(format(.data$Datum, "%Y")), 
                Dekade = round_to_decade(.data$Jahr),
                Dekade_Label = sprintf("%d - %d", 
                                       .data$Dekade - 5, 
                                       .data$Dekade + 4),
                Monat = as.factor(format(.data$Datum, "%m"))) %>% 
  dplyr::left_join(wp_master) %>% 
  dplyr::mutate(Tagesmittelwert_Pegelstand_mNN = as.numeric(.data$Pegelnullpunkt_m) + .data$Tagesmittelwert/100) %>%
  ### remove -777 for messstellennummer 5867000 (few values in 2000) resulted by step above
  dplyr::filter(.data$Tagesmittelwert_Pegelstand_mNN != -777) %>%
  dplyr::select(- .data$Pegelnullpunkt_m) %>% 
  dplyr::mutate(Label = sprintf("%s (%s, id: %s, fluss-km: %2.2f)", 
                                .data$Name,
                                .data$Gewaesser, 
                                .data$Messstellennummer, 
                                as.numeric(.data$Flusskilometer)))

surfacewater_level_master_agg <- surfacewater_level_master %>% 
  dplyr::group_by(.data$Messstellennummer, 
                  .data$Dekade,
                  .data$Dekade_Label, 
                  .data$Monat, 
                  .data$Label) %>% 
  dplyr::summarise(Monatsmittelwert_Pegelstand_mNN = mean(.data$Tagesmittelwert_Pegelstand_mNN),
                   q05 = as.numeric(quantile(.data$Tagesmittelwert_Pegelstand_mNN, probs = 0.05)),
                   q95 = as.numeric(quantile(.data$Tagesmittelwert_Pegelstand_mNN, probs = 0.95)),
                   ) 


decades <- tibble::tibble(names = unique(surfacewater_level_master_agg$Dekade_Label)[order(unique(surfacewater_level_master_agg$Dekade_Label))],
                          values = c('darkblue', 'blue', 'darkgreen', 'lightgreen', 'orange', 'red'))


kwb.utils::preparePdf("surface-water_level.pdf",
                      landscape = TRUE,
                      width.cm = 29.7, 
                      height.cm = 21)

ids <- unique(surfacewater_level_master_agg$Messstellennummer)

for(id in ids) {
p1 <- surfacewater_level_master_agg %>% 
  dplyr::filter(.data$Messstellennummer == id) 

p2 <- surfacewater_level_master %>% 
  dplyr::filter(.data$Jahr == max(.data$Jahr)) %>% 
  dplyr::group_by(.data$Messstellennummer, 
                  .data$Jahr,
                  .data$Monat, 
                  .data$Label) %>% 
  dplyr::summarise(Monatsmittelwert_Pegelstand_mNN = mean(.data$Tagesmittelwert_Pegelstand_mNN),
                   q05 = quantile(.data$Tagesmittelwert_Pegelstand_mNN, probs = 0.05),
                   q95 = quantile(.data$Tagesmittelwert_Pegelstand_mNN, probs = 0.95)) %>% 
  dplyr::filter(.data$Messstellennummer == id) 

n_decades <- length(unique(p1$Dekade_Label))

gg <- p1 %>% 
  ggplot2::ggplot(mapping = ggplot2::aes(x = as.integer(.data$Monat), 
                                         y = .data$Monatsmittelwert_Pegelstand_mNN,
                                         col = as.factor(.data$Dekade_Label))) + 
  #ggplot2::geom_point(alpha = 0.5) + 
  ggplot2::geom_ribbon(ggplot2::aes_string(ymin = "q05", 
                                           ymax = "q95", 
                                           fill = "Dekade_Label"), 
                       alpha = 0.1) + 
  scale_fill_decades(decades) +
  scale_color_decades(decades) +
  ggplot2::geom_point() +
  ggplot2::geom_point(ggplot2::aes(x = as.integer(.data$Monat),
                                   y = .data$Monatsmittelwert_Pegelstand_mNN), 
                      data = p2,
                      col = "darkgrey",
                      alpha = 0.5, 
                      inherit.aes = FALSE,
                      show.legend = FALSE) +
  ggplot2::scale_x_continuous(breaks = 1:12, labels = 1:12, minor_breaks = NULL) +
  #ggplot2::geom_boxplot() +
  ggplot2::facet_wrap( ~ .data$Dekade_Label,
                       nrow = 1, 
                       ncol = n_decades) +
  ggplot2::theme_bw() + 
  ggplot2::theme(legend.position="bottom") +
  ggplot2::labs(y = "Monatsmittel Pegelstand (m NN)", 
                x = "Monatsnummer", 
                col = "Mittelwert", 
                fill = "5%/95% Konf.-intervall",
                title = unique(p1$Label))

plot(gg)
}
dev.off()
```


### Surface Water Flow 

```{r surface_water_flow}
surfacewater_flow_master <- wp_data$surface_water.flow %>% 
  dplyr::filter(.data$Parameter == "Durchfluss") %>%    
  dplyr::mutate(Datum = as.Date(.data$Datum),
                Jahr = as.integer(format(.data$Datum, "%Y")), 
                Dekade = round_to_decade(.data$Jahr),
                Dekade_Label = sprintf("%d - %d", 
                                       .data$Dekade - 5, 
                                       .data$Dekade + 4),
                Monat = as.factor(format(.data$Datum, "%m"))) %>% 
  dplyr::left_join(wp_master) %>% 
  dplyr::mutate(Label = sprintf("%s (%s, id: %s, fluss-km: %2.2f)", 
                                .data$Name,
                                .data$Gewaesser, 
                                .data$Messstellennummer, 
                                as.numeric(.data$Flusskilometer)))

surfacewater_flow_master_agg <- surfacewater_flow_master %>%  
  dplyr::group_by(.data$Messstellennummer, 
                  .data$Dekade,
                  .data$Dekade_Label, 
                  .data$Monat, 
                  .data$Label) %>% 
  dplyr::summarise(Monatsmittelwert = mean(.data$Tagesmittelwert),
                   q05 = as.numeric(quantile(.data$Tagesmittelwert, probs = 0.05)),
                   q95 = as.numeric(quantile(.data$Tagesmittelwert, probs = 0.95)),
                   ) 




decades <- tibble::tibble(names = unique(surfacewater_flow_master_agg $Dekade_Label)[order(unique(surfacewater_flow_master_agg$Dekade_Label))],
                          values = c('darkblue', 'blue', 'darkgreen', 'lightgreen', 'orange', 'red'))



kwb.utils::preparePdf("surface-water_flow.pdf",
                      landscape = TRUE,
                      width.cm = 29.7, 
                      height.cm = 21)

ids <- unique(surfacewater_flow_master_agg$Messstellennummer)

for(id in ids) {
p1 <- surfacewater_flow_master_agg %>% 
  dplyr::filter(.data$Messstellennummer == id) 

p2 <- surfacewater_flow_master %>% 
  dplyr::filter(.data$Jahr == max(.data$Jahr)) %>% 
  dplyr::group_by(.data$Messstellennummer, 
                  .data$Jahr,
                  .data$Monat, 
                  .data$Label) %>% 
  dplyr::summarise(Monatsmittelwert = mean(.data$Tagesmittelwert),
                   q05 = quantile(.data$Tagesmittelwert, probs = 0.05),
                   q95 = quantile(.data$Tagesmittelwert, probs = 0.95)) %>% 
  dplyr::filter(.data$Messstellennummer == id) 

n_decades <- length(unique(p1$Dekade_Label))

gg <- p1 %>% 
  ggplot2::ggplot(mapping = ggplot2::aes(x = as.integer(.data$Monat), 
                                         y = .data$Monatsmittelwert,
                                         col = as.factor(.data$Dekade_Label))) + 
  #ggplot2::geom_point(alpha = 0.5) + 
  ggplot2::geom_ribbon(ggplot2::aes_string(ymin = "q05", 
                                           ymax = "q95", 
                                           fill = "Dekade_Label"), 
                       alpha = 0.1) + 
  scale_fill_decades(decades) +
  scale_color_decades(decades) +
  ggplot2::geom_point() +
  ggplot2::geom_point(ggplot2::aes(x = as.integer(.data$Monat),
                                   y = .data$Monatsmittelwert), 
                      data = p2,
                      col = "darkgrey",
                      alpha = 0.5, 
                      inherit.aes = FALSE,
                      show.legend = FALSE) +
  ggplot2::scale_x_continuous(breaks = 1:12, labels = 1:12, minor_breaks = NULL) +
  #ggplot2::geom_boxplot() +
  ggplot2::facet_wrap( ~ .data$Dekade_Label,
                       nrow = 1, 
                       ncol = n_decades) +
  ggplot2::theme_bw() + 
  ggplot2::theme(legend.position="bottom") +
  ggplot2::labs(y = "Monatsmittel Durchfluss (m\u00B3/s)", 
                x = "Monatsnummer", 
                col = "Mittelwert", 
                fill = "5%/95% Konf.-intervall",
                title = unique(p1$Label))

plot(gg)
}
dev.off()
```


## Download

The plots created with the code above were exported into `pdf` files, which are 
available for download here:


- [surface-water_level.pdf](https://kwb-r.github.io/kwb.impetus/surface-water_level.pdf)

- [surface-water_flow.pdf](https://kwb-r.github.io/kwb.impetus/surface-water_flow.pdf)
