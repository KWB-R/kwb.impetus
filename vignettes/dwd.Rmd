---
title: "Deutscher Wetterdienst (DWD)"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Deutscher Wetterdienst (DWD)}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Define Helper Functions

```{r define_helpers}
summarise_means <- function(data) {
  data %>%
    dplyr::summarise(
      q05 = quantile(.data$mean, probs = 0.05),
      q95 = quantile(.data$mean, probs = 0.95),
      mean = mean(.data$mean)
    )  
}

filter_for_parameter <- function(data, parameter) {
  data %>%
    dplyr::filter(.data$parameter == parameter)
}

filter_for_max_year <- function(data, year) {
  data %>%
    dplyr::filter(.data$Jahr == max(.data$Jahr))
}

aggregate_and_plot <- function(parameter, colors) {
  
  full_data <- kwb.impetus::dwd_berlin_monthly %>% 
    filter_for_parameter(parameter) %>%  
    dplyr::mutate(
      Jahr = as.integer(.data$year), 
      Dekade = kwb.impetus::floor_decade(.data$year),
      Dekade_Label = kwb.impetus::decade_label(.data$Dekade),
      Monat = as.factor(.data$month),
      Label = sprintf("DWD, monthly %s", .data$parameter)
    )
  
  aggregated_data <- full_data %>% 
    kwb.impetus::group_by_decade_month_label() %>% 
    summarise_means()
  
  decades <- kwb.impetus::decades_tibble(
    decade_labels = aggregated_data$Dekade_Label,
    colors = colors
  )
  
  decade_mean_data <- aggregated_data %>%  
    kwb.impetus::group_by_decade_label() %>% 
    dplyr::summarise(annual_mean = sum(.data$mean))
  
  # p1 <- aggregated_data %>%
  #   dplyr::left_join(decade_mean_data) %>%
  #   dplyr::mutate(Dekade_Label = sprintf(
  #     "%s\n%3.1f mm/Jahr)",
  #     .data$Dekade_Label,
  #     round(.data$annual_mean, 1)
  #   ))
  
  p1 <- aggregated_data
  
  p2 <- full_data %>% 
    filter_for_max_year() %>% 
    kwb.impetus::group_by_year_month() %>% 
    summarise_means()
  
  p1 %>% 
    ggplot2::ggplot(mapping = ggplot2::aes(
      x = as.integer(.data$Monat), 
      y = .data$mean,
      col = as.factor(.data$Dekade_Label)
    )) + 
    #ggplot2::geom_point(alpha = 0.5) + 
    kwb.impetus::decade_ribbons() + 
    kwb.impetus::scale_fill_decades(decades) +
    kwb.impetus::scale_color_decades(decades) +
    ggplot2::geom_point() +
    ggplot2::geom_point(ggplot2::aes(
      x = as.integer(.data$Monat),
      y = .data$mean
    ), 
    data = p2,
    col = "darkgrey",
    alpha = 0.5, 
    inherit.aes = FALSE,
    show.legend = FALSE
    ) +
    ggplot2::scale_x_continuous(
      breaks = 1:12, 
      labels = 1:12, 
      minor_breaks = NULL
    ) +
    #ggplot2::geom_boxplot() +
    ggplot2::facet_wrap( 
      ~ .data$Dekade_Label,
      nrow = 1L, 
      ncol = length(unique(p1$Dekade_Label))
    ) +
    ggplot2::theme_bw() + 
    ggplot2::theme(legend.position = "bottom") +
    ggplot2::labs(
      y = "Monatsmittel Niederschlag (mm/Monat)", 
      x = "Monatsnummer", 
      col = "Mittelwert", 
      fill = "5%/95% Konf.-intervall",
      title = unique(p1$Label)
    )
}

print_to_pdf <- function(gg, file, width.cm) {
  
  kwb.utils::preparePdf(
    file, 
    landscape = TRUE, 
    width.cm = width.cm, 
    height.cm = 21
  )

  on.exit(dev.off())
  
  print(gg)
}
```

```{r setup}
library(kwb.impetus)

DT::datatable(kwb.impetus::dwd_berlin_monthly)
```

## Create Plots

```{r no_messages, echo = FALSE}
options(dplyr.summarise.inform = FALSE)
```

### Precipitation

```{r precipitation}
gg <- aggregate_and_plot(parameter = "precipitation", colors = c(
  'darkblue', 'blue', 'darkgreen', 'lightgreen', 'orange', 'red'
))

print_to_pdf(gg, file = "dwd_monthly_precipitation.pdf", width.cm = 50)
```

### Potential Evaporation

```{r potential_evaporation}
gg <- aggregate_and_plot(parameter = "potential evaporation", colors = c(
  'darkgreen', 'lightgreen', 'orange', 'red'
))

print_to_pdf(gg, file = "dwd_monthly_potential-evaporation.pdf", width.cm = 35)
```

## Download

The plots created with the code above were exported into `pdf` files, which are 
available for download here:

```{r download, echo = FALSE, results ='asis'}
files <- sprintf(
  "dwd_monthly_%s.pdf", c("potential-evaporation", "precipitation")
)

cat(paste0(
  sprintf("- [%s](https://kwb-r.github.io/kwb.impetus/%s)", files, files),
  collapse = "\n\n"
))
```
